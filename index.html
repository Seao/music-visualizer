<!doctype html>
<html>
  <head>
    <title>music-visualizer</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="./lib/url.js"></script>
    <script src="./lib/jquery.js"></script>
    <script src="./lib/two.js"></script>
  </head>
  <body style="background: rgb(0, 128, 191);">
    <div class="scripts">
      <script>
        $(() => {
          // create two instance
          const type = /(canvas|webgl)/.test(url.type) ? url.type : 'svg'
          const two = new Two({
            type: Two.Types[type],
            fullscreen: true
          }).appendTo(document.body)

          // instantiation of layers to manage overlays
          const background = two.makeGroup()
          const middleground = two.makeGroup()
          const foreground = two.makeGroup()
          
          /**
           * Creates elements composing the stamp.
           */
          const createStamp = (pointsAmount) => {
            const color = '#FFF'
            const stamp = two.makeGroup()
            const radius = two.height / 6
  
            // main stamp shape
            const core = two.makeCircle(0, 0, radius)
            core.noStroke()
            core.fill = color
            core.radius = radius

            stamp.core = core
            stamp.add(core)
  
            // points adjusted to sound level
            const points = []
            for (var i = 0; i < pointsAmount; i++) {
              const pct = (i + 1) / pointsAmount
              const theta = pct * Math.PI * 2
              const weight = 5
              const x = (radius - weight) * Math.cos(theta)
              const y = (radius - weight) * Math.sin(theta)
              
              const point = two.makeCircle(x, y, weight)
              point.noStroke().fill = '#333'
              point.x = x
              point.y = y

              points.push(point)
            }

            return {
              stamp, points
            }
          }

          /**
           * Translate stamp and points into the screen/.
           */
          const translateStamp = (stamp, points) => {
            stamp.translation.set(two.width / 2, two.height / 2)
            for (const point of points) {
              point.translation.set((two.width / 2) + point.x, (two.height / 2) + point.y)
            }
          }

          const granularity = 28

          const { stamp, points } = createStamp(granularity)
          
          // add stamp to middleground
          middleground.add(stamp)

          translateStamp(stamp, points)

          // render the scene
          two
            .bind('resize', function() {
              translateStamp(stamp, points)
            })
            .play()
        })
      </script>
    </div>
  </body>
</html>
